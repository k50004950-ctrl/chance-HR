# V2 시스템 테스트 가이드

## 🎯 테스트 목표
V2 인증 시스템이 완벽하게 작동하는지 확인하고, 기존 기능과의 호환성을 검증합니다.

---

## 📋 테스트 체크리스트

### Phase 1: 데이터베이스 마이그레이션 확인

#### ✅ 자동 마이그레이션 확인
1. Railway 서버 재시작 확인
2. 서버 로그에서 다음 메시지 확인:
   ```
   🔍 Checking for V2 system tables...
   ✅ V2 tables already exist, skipping migration.
   ```
   또는
   ```
   📦 V2 tables not found, running auto-migration...
   ✅ Auto-migration complete!
   ```

3. 생성된 테이블 확인:
   - `companies` - 회사 정보
   - `company_admins` - 회사 관리자
   - `company_employee_relations` - 회사-직원 관계
   - `matching_requests` - 매칭 요청 (선택사항)

---

### Phase 2: 사업주 회원가입 및 로그인 테스트

#### Test 2.1: 사업주 회원가입
**경로**: `/signup-v2?role=owner`

**테스트 케이스**:

1. **정상 회원가입**
   - 아이디: `test_owner_2026`
   - 비밀번호: `test1234!`
   - 이름: `테스트사업주`
   - 전화번호: `010-1234-5678`
   - 사업자등록번호: `1234567890`
   
   **기대 결과**:
   - ✅ "회원가입이 완료되었습니다!" 메시지
   - ✅ 로그인 페이지로 리다이렉트
   - ✅ DB에 `users` 레코드 생성
   - ✅ DB에 `companies` 레코드 생성
   - ✅ DB에 `company_admins` 레코드 생성

2. **중복 아이디**
   - 동일한 아이디로 재시도
   
   **기대 결과**:
   - ❌ "이미 존재하는 아이디입니다." 에러 메시지

3. **중복 전화번호**
   - 다른 아이디, 동일한 전화번호로 재시도
   
   **기대 결과**:
   - ❌ "이미 등록된 전화번호입니다." 에러 메시지

4. **사업자등록번호 없음**
   - 사업자등록번호 비워두고 가입 시도
   
   **기대 결과**:
   - ❌ "사업자등록번호를 입력해주세요." 에러 메시지

#### Test 2.2: 사업주 로그인
**경로**: `/login-v2`

**테스트 케이스**:

1. **정상 로그인**
   - 위에서 생성한 계정으로 로그인
   
   **기대 결과**:
   - ✅ JWT 토큰 발급
   - ✅ 사업주 대시보드로 이동 (`/owner`)
   - ✅ "매칭 요청" 탭 표시됨

---

### Phase 3: 근로자 회원가입 및 매칭 요청 테스트

#### Test 3.1: 근로자 회원가입
**경로**: `/signup-v2?role=employee`

**테스트 케이스**:

1. **정상 회원가입**
   - 아이디: `test_employee_2026`
   - 비밀번호: `test1234!`
   - 이름: `테스트근로자`
   - 전화번호: `010-9876-5432`
   
   **기대 결과**:
   - ✅ "회원가입이 완료되었습니다!" 메시지
   - ✅ 로그인 페이지로 리다이렉트
   - ✅ DB에 `users` 레코드 생성

#### Test 3.2: 근로자 로그인
**경로**: `/login-v2`

**테스트 케이스**:

1. **정상 로그인**
   - 위에서 생성한 근로자 계정으로 로그인
   
   **기대 결과**:
   - ✅ JWT 토큰 발급
   - ✅ 근로자 대시보드로 이동 (`/employee`)

#### Test 3.3: 회사 검색 및 매칭 요청
**경로**: `/employee/match-request`

**테스트 케이스**:

1. **회사 검색**
   - 사업자등록번호 입력: `123-45-67890`
   - "검색" 버튼 클릭
   
   **기대 결과**:
   - ✅ "회사를 찾았습니다!" 메시지
   - ✅ 회사 정보 표시 (회사명, 대표자명, 전화번호)

2. **매칭 요청 생성**
   - 입사일: 2026-02-01
   - 직급/직책: "매니저"
   - 고용형태: "정규직 (월급제)"
   - 세금 유형: "4대보험"
   - 월급: 3000000
   - "매칭 요청하기" 버튼 클릭
   
   **기대 결과**:
   - ✅ "매칭 요청이 완료되었습니다!" 메시지
   - ✅ DB에 `company_employee_relations` 레코드 생성 (status: 'pending')
   - ✅ 근로자 대시보드로 리다이렉트

---

### Phase 4: 사업주 매칭 승인 테스트

#### Test 4.1: 매칭 요청 목록 조회
**경로**: 사업주 대시보드 → "매칭 요청" 탭

**테스트 케이스**:

1. **매칭 요청 표시**
   
   **기대 결과**:
   - ✅ "🔔 매칭 요청 (1건)" 제목 표시
   - ✅ 근로자 정보 표시 (이름, 전화번호)
   - ✅ 근무 정보 표시 (입사일, 고용형태, 월급 등)
   - ✅ "✅ 승인" 및 "❌ 거부" 버튼 표시

#### Test 4.2: 매칭 승인
**테스트 케이스**:

1. **승인 처리**
   - "✅ 승인" 버튼 클릭
   - 확인 대화상자에서 "확인" 클릭
   
   **기대 결과**:
   - ✅ "매칭이 승인되었습니다." 메시지
   - ✅ DB의 `company_employee_relations` status가 'active'로 변경
   - ✅ DB의 `users` 테이블에서 근로자의 `workplace_id`와 `employment_status` 업데이트
   - ✅ DB의 `employee_details` 레코드 생성
   - ✅ 매칭 요청 목록에서 해당 요청 제거

#### Test 4.3: 매칭 거부
**테스트 케이스**:

1. **새 매칭 요청 생성**
   - 다른 근로자 계정으로 매칭 요청 생성

2. **거부 처리**
   - "❌ 거부" 버튼 클릭
   - 확인 대화상자에서 "확인" 클릭
   
   **기대 결과**:
   - ✅ "매칭이 거부되었습니다." 메시지
   - ✅ DB의 `company_employee_relations` status가 'rejected'로 변경
   - ✅ 매칭 요청 목록에서 해당 요청 제거

---

### Phase 5: 기존 기능 호환성 테스트

#### Test 5.1: 직원 목록에 V2 직원 표시
**경로**: 사업주 대시보드 → "직원 관리" 탭

**테스트 케이스**:

1. **V2로 매칭된 직원 확인**
   
   **기대 결과**:
   - ✅ 승인된 근로자가 직원 목록에 표시됨
   - ✅ 이름, 전화번호, 입사일, 직급, 고용형태 정보 표시

#### Test 5.2: 출퇴근 기능
**경로**: 사업주 대시보드 → "출퇴근 관리" 탭

**테스트 케이스**:

1. **V2 직원 출근 처리**
   - V2로 매칭된 직원의 "출근" 버튼 클릭
   
   **기대 결과**:
   - ✅ 출근 시간 기록됨
   - ✅ DB의 `attendance` 테이블에 레코드 생성

2. **V2 직원 퇴근 처리**
   - V2로 매칭된 직원의 "퇴근" 버튼 클릭
   
   **기대 결과**:
   - ✅ 퇴근 시간 기록됨
   - ✅ 근무 시간 자동 계산

#### Test 5.3: 급여 계산
**경로**: 사업주 대시보드 → "급여 관리" 탭

**테스트 케이스**:

1. **V2 직원 급여 계산**
   - "요율 적용" 버튼 클릭
   - V2로 매칭된 직원의 급여 정보 확인
   
   **기대 결과**:
   - ✅ 월급 정보 표시
   - ✅ 4대보험 공제액 계산
   - ✅ 사업주 부담금 계산

2. **급여 확정**
   - "급여 확정" 버튼 클릭
   
   **기대 결과**:
   - ✅ DB의 `salary_slips` 테이블에 레코드 생성
   - ✅ DB의 `payroll_finalized` 테이블에 레코드 생성

#### Test 5.4: 급여명세서 발송
**경로**: 사업주 대시보드 → "급여명세서 관리" 탭

**테스트 케이스**:

1. **V2 직원 급여명세서 발송**
   - V2로 매칭된 직원의 "급여명세서 발송" 버튼 클릭
   
   **기대 결과**:
   - ✅ 급여명세서 발송 완료
   - ✅ 근로자가 자신의 대시보드에서 급여명세서 확인 가능

---

### Phase 6: 퇴사 처리 테스트

#### Test 6.1: V2 퇴사 처리
**테스트 케이스**:

1. **퇴사 처리**
   - V2 API를 통해 퇴사 처리:
     ```javascript
     POST /api/v2/auth/employee/resign
     Body: { relationId: <relation_id>, endDate: "2026-03-31" }
     ```
   
   **기대 결과**:
   - ✅ DB의 `company_employee_relations`에서 `end_date` 및 `resignation_date` 설정, status가 'resigned'로 변경
   - ✅ DB의 `users` 테이블에서 `employment_status`가 'resigned'로 변경, `resignation_date` 설정
   - ✅ DB의 `employee_details`에서 `resignation_date` 설정
   - ✅ 사업주 대시보드 직원 목록에서 퇴사자로 표시

#### Test 6.2: 퇴사자의 급여명세서 접근
**경로**: 근로자 대시보드

**테스트 케이스**:

1. **과거 급여명세서 조회**
   - 퇴사한 근로자 계정으로 로그인
   - "급여명세서" 탭 확인
   
   **기대 결과**:
   - ✅ 과거에 발급된 모든 급여명세서 표시
   - ✅ 퇴사 후에도 접근 가능

---

### Phase 7: 재취업 테스트

#### Test 7.1: 다른 회사로 재취업
**테스트 케이스**:

1. **새 회사 등록**
   - 다른 사업주 계정 생성 (사업자등록번호: `0987654321`)

2. **퇴사한 근로자가 새 회사에 매칭 요청**
   - 퇴사한 근로자 계정으로 로그인
   - `/employee/match-request`로 이동
   - 새 회사 검색 및 매칭 요청
   
   **기대 결과**:
   - ✅ 새 회사 검색 성공
   - ✅ 매칭 요청 생성 성공
   - ✅ DB에 새 `company_employee_relations` 레코드 생성

3. **새 회사 사업주가 승인**
   - 새 사업주 계정으로 로그인
   - 매칭 요청 승인
   
   **기대 결과**:
   - ✅ 승인 성공
   - ✅ 근로자가 새 회사의 직원 목록에 표시
   - ✅ 기존 회사의 급여명세서는 여전히 접근 가능

---

### Phase 8: 통합 시나리오 테스트

#### Scenario 1: 완전한 고용 사이클
1. 근로자 회원가입
2. 회사 검색 및 매칭 요청
3. 사업주 승인
4. 3개월 근무 (출퇴근 기록)
5. 3개월치 급여 지급
6. 퇴사 처리
7. 퇴사 후 과거 급여명세서 조회
8. 다른 회사로 재취업

#### Scenario 2: 여러 직원 동시 관리
1. 5명의 근로자 회원가입
2. 5명 모두 동일한 회사에 매칭 요청
3. 3명 승인, 2명 거부
4. 승인된 3명의 출퇴근 관리
5. 승인된 3명의 급여 계산 및 발송

---

## 🐛 알려진 이슈 및 제한사항

1. **V2 시스템과 기존 시스템의 데이터 동기화**
   - 매칭 승인 시 자동으로 기존 시스템 테이블 업데이트
   - 퇴사 시 자동으로 기존 시스템 테이블 업데이트
   - 양방향 동기화는 아직 미구현

2. **본인인증 기능**
   - 현재 미구현 (Phase 2에서 추가 예정)
   - 전화번호 중복 검사만 수행

3. **사업자등록번호 검증**
   - 국세청 API 연동 미구현
   - 형식 검증만 수행 (10자리 숫자)

---

## ✅ 테스트 완료 체크리스트

### 데이터베이스
- [ ] 자동 마이그레이션 성공
- [ ] 모든 V2 테이블 생성 확인

### 회원가입/로그인
- [ ] 사업주 회원가입 성공
- [ ] 근로자 회원가입 성공
- [ ] 중복 검사 작동
- [ ] 로그인 성공

### 매칭 시스템
- [ ] 회사 검색 성공
- [ ] 매칭 요청 생성 성공
- [ ] 매칭 요청 목록 표시
- [ ] 매칭 승인 성공
- [ ] 매칭 거부 성공

### 기존 기능 호환성
- [ ] V2 직원이 직원 목록에 표시
- [ ] V2 직원 출퇴근 기록 가능
- [ ] V2 직원 급여 계산 가능
- [ ] V2 직원 급여명세서 발송 가능

### 퇴사 및 재취업
- [ ] 퇴사 처리 성공
- [ ] 퇴사 후 급여명세서 접근 가능
- [ ] 다른 회사로 재취업 가능

---

## 📞 문제 발생 시

1. **서버 로그 확인**
   - Railway 대시보드에서 실시간 로그 확인
   - 오류 메시지 복사

2. **데이터베이스 확인**
   - Railway PostgreSQL 콘솔에서 테이블 조회
   ```sql
   SELECT * FROM companies;
   SELECT * FROM company_admins;
   SELECT * FROM company_employee_relations;
   ```

3. **브라우저 콘솔 확인**
   - F12 개발자 도구 → Console 탭
   - Network 탭에서 API 요청/응답 확인

4. **문제 보고**
   - 오류 메시지
   - 재현 단계
   - 스크린샷

---

## 🎉 완료!

모든 테스트를 통과하면 V2 시스템이 완전히 작동하는 것입니다!

다음 단계:
1. 실제 사용자 초대 및 피드백 수집
2. 본인인증 기능 추가 (Phase 2)
3. 국세청 API 연동 (Phase 2)
